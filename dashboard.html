<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioAML Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Enhanced Gradient for Header */
        .header-bg { background: linear-gradient(105deg, #1d4ed8, #059669); }
        .card { transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .card:hover { transform: translateY(-3px); box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15); }
        /* Styling for the Prediction Activity chart */
        #activityGraphContainer { height: 28rem; }
        /* Modal Overlay Styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 50;
        }
        .progress-bar {
            height: 10px;
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        /* Fix for Tailwind v2 compatibility issues with flex-grow in buttons */
        .btn-flex { flex: 1 1 0%; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">
    <header class="header-bg text-white shadow-xl z-20 sticky top-0">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-white hover:text-gray-200 transition duration-200">
                <a href="index.html" class="text-white hover:text-gray-200 transition duration-200 block">
                    <h1 class="text-3xl font-extrabold tracking-tight cursor-pointer">BioAML</h1>
                </a>
            </a>
            <div class="flex items-center space-x-6">
                <div id="userMenu" class="relative">
                    <button onclick="toggleDropdown()" class="flex items-center space-x-2 p-2 rounded-lg transition duration-200 hover:bg-white hover:bg-opacity-10 focus:outline-none">
                        <span id="userName" class="text-lg font-semibold cursor-pointer">Guest User</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div id="userDropdownMenu" class="absolute right-0 mt-3 w-64 bg-white rounded-xl shadow-2xl transition duration-300 transform origin-top-right z-30 hidden opacity-0 scale-95">
                        <div class="p-4 border-b border-gray-100">
                            <p id="dropdown-userName" class="text-lg font-bold text-gray-800" data-bind="userName">Guest User</p>
                            <p id="userEmail" class="text-sm text-gray-500 truncate" data-bind="userEmail">Please log in</p>
                        </div>
                        <nav class="p-2 space-y-1">
                            <a href="#" onclick="alert('Logged out successfully!'); sessionStorage.removeItem('userName'); sessionStorage.removeItem('userEmail'); window.location.href='index.html';" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition duration-150">
                                Logout
                            </a>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="flex flex-1 pt-6">
        <aside class="w-64 bg-white p-6 shadow-2xl sticky top-24 h-screen-overflow hidden lg:block" style="height: calc(100vh - 6rem);">
            <nav class="space-y-4">
                <a href="#" class="flex items-center p-3 text-green-600 font-bold bg-green-50 rounded-lg shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Dashboard
                </a>
                <a href="#" class="flex items-center p-3 text-gray-600 font-medium hover:bg-gray-100 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                    Reports
                </a>
                <a href="#" class="flex items-center p-3 text-gray-600 font-medium hover:bg-gray-100 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.39a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.56a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.22.39a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.73v-.56a2 2 0 0 1 1-1.73l.15-.08a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2-0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    Settings
                </a>
            </nav>
        </aside>
        <main class="flex-1 lg:ml-6 px-4 pb-10">
            <div id="simulationWarning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-8 rounded-xl shadow-lg" role="alert">
                <p class="font-bold">Dashboard Simulation Active: Layered Subscriptions</p>
                <p class="text-sm">The dashboard is currently combining data from all active subscriptions.</p>
                <button id="togglePlanBtn" class="mt-2 text-sm text-yellow-800 underline font-semibold hover:text-yellow-900 transition duration-200">
                    Click here to simulate a different mix of subscriptions!
                </button>
            </div>
            <div class="mb-10">
                <h3 class="text-2xl font-bold mb-4 text-gray-800 mt-4">Module Usage Summary</h3>
                <div id="moduleGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="noModulesMessage" class="text-center text-gray-500 py-12" style="display:none;">
                    <p class="text-xl font-semibold">No active modules found.</p>
                    <p class="text-base mt-2">Visit the <a href="pricing.html" class="text-green-600 underline hover:text-green-700">Pricing Page</a> to purchase a module.</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-xl mb-10">
                <h3 class="text-2xl font-bold mb-6 border-b pb-2">Prediction Activity (Last 4 Weeks)</h3>
                <div id="activityGraphContainer" class="p-4 bg-gray-50 rounded-lg border border-gray-200"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h3 class="text-2xl font-bold mb-4 border-b pb-2">Stored Prediction Analysis</h3>
                <div id="storedAnalysisList" class="space-y-4">
                    <p id="noAnalysisMessage" class="text-center text-gray-500 py-8">No analyses found for your current services.</p>
                </div>
            </div>
        </main>
    </div>
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto text-center">
            <p class="text-sm font-medium">&copy; 2025 BioAML. All rights reserved. | <a href="#" class="text-green-400 hover:text-green-200">Privacy Policy</a></p>
        </div>
    </footer>
    <div id="progressModal" class="fixed inset-0 hidden items-center justify-center modal-overlay transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 transform scale-95 opacity-0 transition-all duration-300" id="progressModalContent">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-xl font-extrabold text-green-600" id="progressModalTitle">Prediction Progress</h3>
                <button onclick="closeProgressModal()" class="text-gray-400 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">
                    Track your prediction scores over time. A rising line suggests improved accuracy and proficiency in your input data.
                </p>
                <div class="h-80 w-full">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
            <div class="p-4 border-t text-right">
                <button onclick="closeProgressModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Globals
        let auth, db;
        
        // Configuration Check
        const firebaseConfig = {
          apiKey: "AIzaSyBEKINObrsmPdd-SPv-vD4v-gfJReAoYpM",
          authDomain: "bioaml.firebaseapp.com",
          projectId: "bioaml",
          storageBucket: "bioaml.firebasestorage.app",
          messagingSenderId: "778735157645",
          appId: "1:778735157645:web:1f1580bb3596c0aa18fdc4",
          measurementId: "G-3KLFW5G4P3"
        };
        // --- NAME HANDLING LOGIC ---
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        const nameFromUrl = getUrlParameter('name');
        const defaultPlaceholderName = "Guest User";
        const nameToSet = nameFromUrl || defaultPlaceholderName;
        

// Initialize and Authenticate
// dashboard10.html (around line 185)

// Initialize and Authenticate
        async function initializeFirebaseAndAuthenticate() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    setLogLevel('debug');
        
                    // --- USE onAuthStateChanged to detect existing sessions first ---
                    const initialUserPromise = new Promise(resolve => {
                        const unsubscribe = auth.onAuthStateChanged(user => {
                            unsubscribe(); // Stop listening once we get the initial state
                            resolve(user);
                        });
                    });
        
                    let currentUser = await initialUserPromise;
        
                    // 1. Check for a Custom Token (Simulated environment)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                        currentUser = userCredential.user;
                    } 
                    // 2. Fallback to Anonymous ONLY if no user is signed in
                    else if (!currentUser) {
                        console.warn("No persistent user or custom token found. Falling back to anonymous sign-in.");
                        // This is the line that caused the error, but we only run it if NO session is found.
                        const userCredential = await signInAnonymously(auth);
                        currentUser = userCredential.user;
                    } 
                    
                    // 3. User Profile Update
                    if (currentUser && (!currentUser.displayName || nameFromUrl)) {
                        console.log(`Setting displayName to: ${nameToSet}`);
                        await updateProfile(currentUser, {
                            displayName: nameToSet
                        });
                        currentUser = auth.currentUser;
                    }
                    
                    // 4. Load info (will prioritize sessionStorage if available, which it is after sign-in)
                    loadUserInfo(currentUser);
                } else {
                    // Simulated User Data (if Firebase config is missing)
                    console.warn("Firebase config not available. Using simulated user data.");
                    loadUserInfo({
                        email: "simulated.user@bioaml.com",
                        uid: crypto.randomUUID(),
                        displayName: nameToSet
                    });
                }
            } catch (e) {
                // Crucial change: log the error but still rely on sessionStorage for username display
                console.error("Firebase authentication failed:", e);
                loadUserInfo(null); 
            }
        }

// ... rest of the script ...
        function loadUserInfo(user) {
            // 1. Check Session Storage for Name/Email
            const sessionName = sessionStorage.getItem('userName');
            const sessionEmail = sessionStorage.getItem('userEmail');
            
            // 2. Use Session Storage data if available
            if (sessionName && sessionEmail) {
                document.getElementById('userName').textContent = sessionName;
                document.getElementById('userEmail').textContent = sessionEmail;
                return; // Exit the function since we've loaded the data
            }

            // 3. Fallback to Firebase/Simulated User object (Original logic)
            if (user) {
                // Use user.displayName or user.email prefix if they exist, otherwise a placeholder
                const nameText = user.displayName || user.email?.split('@')[0] || `User #${user.uid.substring(0, 8)}`;
                const emailText = user.email || `UID: ${user.uid}`;
                document.getElementById('userName').textContent = nameText;
                document.getElementById('userEmail').textContent = emailText;
            } else {
                // Fallback for no user/error
                document.getElementById('userName').textContent = "Guest User";
                document.getElementById('userEmail').textContent = "Please log in";
            }
        }
        // Add this code inside your <script type="module"> block
        
        // Function to open/close the dropdown menu
        window.toggleDropdown = function() {
            const menu = document.getElementById('userDropdownMenu');
            
            // Toggle the 'hidden' class
            menu.classList.toggle('hidden');
        
            // Apply animation classes
            if (!menu.classList.contains('hidden')) {
                // Show menu
                setTimeout(() => {
                    menu.classList.remove('opacity-0', 'scale-95');
                    menu.classList.add('opacity-100', 'scale-100');
                }, 10);
            } else {
                // Hide menu
                menu.classList.remove('opacity-100', 'scale-100');
                menu.classList.add('opacity-0', 'scale-95');
            }
        }
        
        // Function to close the dropdown when clicking outside of it
        document.addEventListener('click', function(event) {
            const userMenuContainer = document.getElementById('userMenu');
            const userDropdownMenu = document.getElementById('userDropdownMenu');
            
            // Check if the click occurred outside the menu container AND the menu is currently visible
            if (userMenuContainer && userDropdownMenu && 
                !userMenuContainer.contains(event.target) &&
                !userDropdownMenu.classList.contains('hidden')) 
            {
                // Close the menu smoothly
                userDropdownMenu.classList.remove('opacity-100', 'scale-100');
                userDropdownMenu.classList.add('opacity-0', 'scale-95');
                // Wait for the transition to finish before hiding completely
                setTimeout(() => {
                    userDropdownMenu.classList.add('hidden');
                }, 300); // 300ms matches the 'duration-300' class
            }
        });
        // --- SERVICE STYLES ---
        const SERVICE_STYLES = {
            'Genomic': { color: 'green', primaryBorder: 'border-green-500', primaryText: 'text-green-700', bg: 'bg-green-50', hoverBorder: 'border-green-400', hex: '#10b981', icon: '<path d="M12 2l10 20-10-5-10 5 10-20z"/><path d="M12 2v20"/>' },
            'Angiography': { color: 'green', primaryBorder: 'border-green-500', primaryText: 'text-green-700', bg: 'bg-green-50', hoverBorder: 'border-green-400', hex: '#10b981', icon: '<circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 0-7 17l.95-.95"/><path d="M12 2a10 10 0 0 1 7 17l-.95-.95"/>' },
            'Radiology': { color: 'green', primaryBorder: 'border-green-500', primaryText: 'text-green-700', bg: 'bg-green-50', hoverBorder: 'border-green-400', hex: '#10b981', icon: '<rect x="3" y="3" width="18" height="18" rx="2"/><line x="12" y="3" x2="12" y2="21"/>' },
            'Default': { color: 'green', primaryBorder: 'border-green-500', primaryText: 'text-green-700', bg: 'bg-green-50', hoverBorder: 'border-green-400', hex: '#10b981', icon: '<circle cx="12" cy="12" r="10"/>' }
        };

        // Simulated Progress Reports
        const PROGRESS_REPORTS = {
            'Angiography': [
                { id: 'A100', type: 'Angiography', result: 'Fair (65)', date: '2025-09-20', score: 65 },
                { id: 'A101', type: 'Angiography', result: 'Medium (70)', date: '2025-09-22', score: 70 },
                { id: 'A102', type: 'Angiography', result: 'Good (80)', date: '2025-09-25', score: 80 },
                { id: 'A103', type: 'Angiography', result: 'Very Good (88)', date: '2025-09-28', score: 88 },
                { id: 'A104', type: 'Angiography', result: 'Excellent (95)', date: '2025-10-02', score: 95 },
            ],
            'Genomic': [
                { id: 'G100', type: 'Genomic', result: 'Low (60)', date: '2025-09-20', score: 60 },
                { id: 'G101', type: 'Genomic', result: 'Medium (75)', date: '2025-09-22', score: 75 },
                { id: 'G102', type: 'Genomic', result: 'Good (82)', date: '2025-09-25', score: 82 },
                { id: 'G103', type: 'Genomic', result: 'Very Good (90)', date: '2025-09-28', score: 90 },
                { id: 'G104', type: 'Genomic', result: 'Excellent (97)', date: '2025-10-02', score: 97 },
            ],
            'Radiology': [
                { id: 'R100', type: 'Radiology', result: 'Fair (62)', date: '2025-09-20', score: 62 },
                { id: 'R101', type: 'Radiology', result: 'Medium (73)', date: '2025-09-22', score: 73 },
                { id: 'R102', type: 'Radiology', result: 'Good (85)', date: '2025-09-25', score: 85 },
                { id: 'R103', type: 'Radiology', result: 'Very Good (89)', date: '2025-09-28', score: 89 },
                { id: 'R104', type: 'Radiology', result: 'Excellent (94)', date: '2025-10-02', score: 94 },
            ]
        };
        
        // Plans Catalog
        const PLANS_CATALOG = {
          'free_plan': {
            name: "Free Plan",
            description: "Includes 3 predictions per module",
            services: ['Genomic', 'Angiography', 'Radiology'],
            quota: {
              Genomic: { limit: 3, used: 0 },
              Angiography: { limit: 3, used: 0 },
              Radiology: { limit: 3, used: 0 },
            },
          },
          'basic_plan': {
            name: "Basic Plan",
            description: "Includes 30 predictions per module",
            services: ['Genomic', 'Angiography', 'Radiology'],
            quota: {
              Genomic: { limit: 30, used: 0 },
              Angiography: { limit: 30, used: 0 },
              Radiology: { limit: 30, used: 0 },
            },
          },
          'premium_plan': {
            name: "Premium Plan",
            description: "Includes unlimited predictions per module",
            services: ['Genomic', 'Angiography', 'Radiology'],
            quota: {
              Genomic: { limit: null, used: 0 },
              Angiography: { limit: null, used: 0 },
              Radiology: { limit: null, used: 0 },
            },
          },
        };
        
        const SUBSCRIPTION_SCENARIOS = [
          { key: 'Free Plan', subscriptions: ['free_plan'] },
          { key: 'Basic Plan', subscriptions: ['basic_plan'] },
          { key: 'Premium Plan', subscriptions: ['premium_plan'] },
        ];


        
        // ... PLANS_CATALOG definition follows ...
        let currentScenarioIndex = 0;
        let progressChartInstance = null;
        let currentModule = 'Angiography';

        // dashboard (7).html (around line 496)
        
        function aggregateUserDataFromSubscriptions(subscriptionKeys) {
          const aggregatedData = {
            activePlans: [],
            services: new Set(),
            quota: {},
            reports: [],
            paidServices: new Set() // Tracks which services are covered by paid plans
          };
          
          // 1. Process Paid Subscriptions
          subscriptionKeys.forEach(key => {
            const plan = PLANS_CATALOG[key];
            if (!plan) return;
            aggregatedData.activePlans.push(plan.name);
            
            plan.services.forEach(service => {
              aggregatedData.services.add(service);
              aggregatedData.paidServices.add(service); // Mark as paid
              const newQuota = plan.quota[service];
              
              // Aggregation logic for paid services
              if (!aggregatedData.quota[service]) {
                aggregatedData.quota[service] = { ...newQuota, isFree: false };
              } else {
                let existingQuota = aggregatedData.quota[service];
                if (existingQuota.limit === null || newQuota.limit === null) {
                  existingQuota.limit = null;
                } else {
                  existingQuota.limit += newQuota.limit;
                }
              }
            });
          });
          
          // 2. Add free plan services if no paid subscription
          if (aggregatedData.activePlans.length === 0) {
            const freePlan = PLANS_CATALOG['free_plan'];
            freePlan.services.forEach(service => {
              aggregatedData.services.add(service);
              aggregatedData.quota[service] = { ...freePlan.quota[service], isFree: true };
            });
          }
          
          aggregatedData.services = Array.from(aggregatedData.services);
          return aggregatedData;
        }

        async function renderDashboard(scenario) {
          const data = aggregateUserDataFromSubscriptions(scenario.subscriptions);
          await renderModuleCards(data);
          renderActivityGraph(data.quota, data.services);
          await renderStoredAnalysis();
        }

        function getServiceStyle(serviceName) {
            return SERVICE_STYLES[serviceName] || SERVICE_STYLES.Default;
        }

        // Add this function to get the user's plan
        async function getUserPlan(uid) {
          if (!uid) return 'free_plan'; // default plan if no user is signed in
          try {
            const userDocRef = doc(db, `users/${uid}/user_data/profile`);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
              const userData = userDoc.data();
              return userData.subscription;
            } else {
              return 'free_plan'; // default plan if no subscription is found
            }
          } catch (error) {
            console.error("Error fetching user plan:", error);
            return 'free_plan'; // default plan if an error occurs
          }
        }
        async function renderModuleCards(data) {
          const moduleGrid = document.getElementById('moduleGrid');
          const noModulesMessage = document.getElementById('noModulesMessage');
          let modulesHtml = '';
          if (data.services.length === 0) {
            moduleGrid.innerHTML = '';
            noModulesMessage.style.display = 'block';
            return;
          }
          noModulesMessage.style.display = 'none';
        
          let counts = {};
          if (auth.currentUser) {
            try {
              const result = await fetchStoredAnalysisFromFirebase(auth.currentUser.uid);
              counts = result.counts;
              
            } catch (error) {
              console.error("Error fetching stored analysis:", error);
            }
          }
          let userPlan;
          if (auth.currentUser) {
            userPlan = await getUserPlan(auth.currentUser.uid);
          } else {
            userPlan = 'free_plan'; // default plan
          }            
          for (const service of data.services) {
            const quota = data.quota[service];
            if (!quota) continue;
            const isUnlimited = quota.limit === null;
            const used = quota.used;
            const limit = quota.limit;
            const remainingText = isUnlimited ? 'Unlimited' : `${limit - used} remaining`;
            const percentageUsed = isUnlimited ? 0 : Math.min((used / limit) * 100, 100);
            const style = getServiceStyle(service);
            const plan = userPlan;
            // console.log(`User Plan declared: ${userPlan}`);
            const planColor = plan === 'free' ? 'bg-red-500' : (plan === 'basic' ? 'bg-yellow-500' : 'bg-green-500');
        
            // Check if the prediction button should be disabled
            const isFreeLimitReached = !isUnlimited && used >= limit;
            const buttonDisabledClass = isFreeLimitReached ? 'opacity-50 cursor-not-allowed pointer-events-none' : '';
        
            const moduleSpecificActions = `
              <div class="flex space-x-3">
                <a href="${service.toLowerCase()}.html" class="btn-flex px-3 py-2 text-sm font-bold rounded-lg bg-${style.color}-600 text-white hover:bg-${style.color}-700 transition duration-200 shadow-md text-center transform hover:scale-105 ${buttonDisabledClass}">
                  New Prediction
                </a>
                <button onclick="showProgressModal('${service}')" class="btn-flex px-3 py-2 text-sm font-bold rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-100 transition duration-200 shadow-sm text-center">
                  View Progress
                </button>
              </div>
              <div class="mt-3">
                <a href="pricing.html?module=${service}" class="px-3 py-2 text-sm font-bold rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-100 transition duration-200 shadow-sm w-full text-center flex items-center justify-center block">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  Manage Subscription
                </a>
              </div>
            `;
            modulesHtml += `
              <div class="card bg-white p-6 rounded-xl shadow-xl border-t-8 ${style.primaryBorder} flex flex-col justify-between relative">
                <div class="absolute top-4 right-4 ${planColor} w-4 h-4 rounded-full"></div>
                <div class="flex items-start justify-between mb-4 pb-3 border-b border-gray-100">
                  <h3 class="text-2xl font-extrabold text-gray-900">${service} Module</h3>
                  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-${style.color}-500">${style.icon}</svg>
                </div>
                <div class="mb-4">
                  <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Monthly Usage</p>
                  <div class="flex items-end justify-between">
                    <span class="text-4xl font-black text-gray-900">${used}</span>
                    <span class="text-xl font-bold ${isUnlimited ? 'text-green-600' : 'text-gray-500'}">${isUnlimited ? 'Unlimited' : `/ ${limit}`}</span>
                  </div>
                </div>
                <div class="space-y-2 mb-6">
                  <p class="text-sm text-gray-600 font-medium">${remainingText} left</p>
                  <div class="progress-bar bg-gray-200 relative">
                    <div class="bg-${style.color}-600 absolute top-0 left-0 h-full" style="width: ${percentageUsed}%;"></div>
                  </div>
                </div>
                <div class="pt-3 border-t border-gray-100">
                  ${moduleSpecificActions}
                </div>
              </div>
            `;
          };
        
          moduleGrid.innerHTML = modulesHtml;
        }

        function renderActivityGraph(quotaData, activeServices) {
            const container = document.getElementById('activityGraphContainer');
            const weeklyData = {};
            let maxCount = 1;
            activeServices.forEach(service => {
                const dataPoints = quotaData[service]?.total_used || [];
                for (let i = 0; i < dataPoints.length; i++) {
                    const count = dataPoints[i];
                    weeklyData[i] = weeklyData[i] || {};
                    weeklyData[i][service] = count;
                    const totalForWeek = Object.values(weeklyData[i]).reduce((a, b) => a + b, 0);
                    if (totalForWeek > maxCount) {
                        maxCount = totalForWeek;
                    }
                }
            });
            const totalWeeks = 4;
            const weekLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            let barsHtml = '';
            for (let i = 0; i < totalWeeks; i++) {
                const weekCounts = weeklyData[i] || {};
                const totalCount = Object.values(weekCounts).reduce((a, b) => a + b, 0);
                const totalHeight = (totalCount / maxCount) * 200;
                let segmentsHtml = '';
                let cumulativeHeight = 0;
                activeServices.slice().reverse().forEach((service) => {
                    const count = weekCounts[service] || 0;
                    if (count > 0) {
                        const style = getServiceStyle(service);
                        const segmentHeight = totalCount > 0 ? (count / totalCount) * totalHeight : 0;
                        let roundedClass = cumulativeHeight === 0 ? 'rounded-t-lg' : '';
                        segmentsHtml = `
                            <div class="${roundedClass} bg-${style.color}-500" 
                                style="height: ${segmentHeight}px; min-height: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" 
                                title="${count} ${service} Predictions">
                            </div>
                        ` + segmentsHtml;
                        cumulativeHeight += segmentHeight;
                    }
                });
                barsHtml += `
                    <div class="flex flex-col items-center group relative h-full">
                        <div class="absolute bottom-0 w-10 flex flex-col items-center justify-end" style="height: ${totalHeight}px;">
                            ${segmentsHtml}
                        </div>
                        <span class="text-xs mt-2 absolute -bottom-6 font-medium text-gray-700">${weekLabels[i]}</span>
                        <span class="text-sm text-gray-900 font-extrabold absolute top-0 transform -translate-y-full transition duration-300 group-hover:scale-110">${totalCount > 0 ? totalCount : ''}</span>
                    </div>
                `;
            }
            let legendHtml = activeServices.length > 0 ? activeServices.map(service => {
                const style = getServiceStyle(service);
                return `<span class="flex items-center text-sm font-medium text-gray-600">
                            <span class="w-3 h-3 rounded-full mr-2 shadow-sm bg-${style.color}-500"></span>${service}
                        </span>`;
            }).join('') : '';
            const graphContent = `
                <div class="flex justify-around items-end h-72 p-4 space-x-12 relative">
                    <span class="absolute left-0 top-0 text-xs font-semibold text-gray-500">Max: ${maxCount}</span>
                    ${barsHtml}
                </div>
                <div class="flex justify-center space-x-8 text-sm text-gray-500 mt-10 p-2 border-t border-gray-200">
                    ${legendHtml}
                </div>
            `;
            container.innerHTML = graphContent;
        }



        window.showProgressModal = function(module) {
            currentModule = module;
            const modal = document.getElementById('progressModal');
            const modalContent = document.getElementById('progressModalContent');
            const modalTitle = document.getElementById('progressModalTitle');
            modalTitle.textContent = `${module} Prediction Progress`;
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            renderProgressChart(PROGRESS_REPORTS[module] || []);
        }

        window.closeProgressModal = function() {
            const modal = document.getElementById('progressModal');
            const modalContent = document.getElementById('progressModalContent');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            modal.classList.remove('opacity-100');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function renderProgressChart(reports) {
            if (progressChartInstance) {
                progressChartInstance.destroy();
            }
            const chartData = reports.map((r, index) => ({
                x: `Pred. ${index + 1}`,
                y: r.score
            }));
            const labels = chartData.map(d => d.x);
            const scores = chartData.map(d => d.y);
            const ctx = document.getElementById('progressChart').getContext('2d');
            progressChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Prediction Score (%)',
                        data: scores,
                        borderColor: getServiceStyle(currentModule).hex,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: getServiceStyle(currentModule).hex,
                        pointHoverRadius: 8,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 50,
                            max: 100,
                            title: { display: true, text: 'Score (%)' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            title: { display: true, text: 'Prediction Attempt' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Score: ${context.parsed.y}%`
                            }
                        },
                        title: {
                            display: true,
                            text: `${currentModule} Score Improvement Timeline`,
                            font: { size: 16, weight: 'bold' }
                        }
                    }
                }
            });
        }

        const togglePlanBtn = document.getElementById('togglePlanBtn');
        function cyclePlan() {
            currentScenarioIndex = (currentScenarioIndex + 1) % SUBSCRIPTION_SCENARIOS.length;
            const currentScenario = SUBSCRIPTION_SCENARIOS[currentScenarioIndex];
            const nextScenarioIndex = (currentScenarioIndex + 1) % SUBSCRIPTION_SCENARIOS.length;
            const nextScenarioName = SUBSCRIPTION_SCENARIOS[nextScenarioIndex].key;
            togglePlanBtn.textContent = `Click here to simulate the '${nextScenarioName}' scenario!`;
            renderDashboard(currentScenario);
        }
        togglePlanBtn.addEventListener('click', cyclePlan);
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseAndAuthenticate();
            cyclePlan();
        });
        async function fetchStoredAnalysisFromFirebase(uid) {
          if (!db || !uid) return { predictions: [], counts: {} };
          const predictionsRef = collection(db, `users/${uid}/predictions`);
          const snapshot = await getDocs(predictionsRef);
          const predictions = snapshot.docs.map(doc => ({
            id: doc.data().id,
            type: doc.data().module,
            date: doc.data().date,
            result: doc.data().result,
            score: doc.data().score,
            color: doc.data().score > 0.5 ? 'text-red-600' : 'text-green-600'
          }));
        
          // Count predictions for each module
          const counts = {};
          predictions.forEach(prediction => {
            if (!counts[prediction.type]) {
              counts[prediction.type] = 1;
            } else {
              counts[prediction.type]++;
            }
          });
        
          return { predictions, counts };
        }
        
          // Update renderStoredAnalysis to use fetched data
        async function renderStoredAnalysis() {
          if (!auth.currentUser) return;
          const result = await fetchStoredAnalysisFromFirebase(auth.currentUser.uid);
          const reports = result.predictions;
          const listContainer = document.getElementById('storedAnalysisList');
          const noMessage = document.getElementById('noAnalysisMessage');
          if (reports.length === 0) {
            listContainer.innerHTML = '';
            noMessage.style.display = 'block';
            return;
          }
          noMessage.style.display = 'none';
          const sortedReports = reports.sort((a, b) => new Date(b.date) - new Date(a.date));
          let reportsHtml = sortedReports.map(report => {
            const style = getServiceStyle(report.type);
            const linkPath = `${report.type.toLowerCase()}.html?id=${report.id}`;
            const resultText = report.result || `Score: ${(report.score * 100).toFixed(2)}%`;
            return `
              <div class="p-5 border-l-4 ${style.primaryBorder} rounded-xl bg-white flex justify-between items-center shadow-lg hover:shadow-xl transition duration-300 hover:border-${style.color}-600">
                <div class="flex items-center space-x-4">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-${style.color}-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                  <div>
                    <p class="font-bold text-lg text-gray-900">${report.type} Analysis - [Ref: ${report.id}]</p>
                    <p class="text-sm text-gray-600 mt-1">
                      Result: <span class="font-extrabold ${report.color || 'text-gray-900'}">${resultText}</span> 
                      <span class="ml-4 text-gray-400">|</span> 
                      <span class="ml-4">Completed on ${new Date(report.date).toLocaleDateString()}</span>
                    </p>
                  </div>
                </div>
                <a href="${linkPath}" class="text-green-500 hover:text-green-700 text-sm font-bold p-3 rounded-lg bg-green-50 hover:bg-green-100 transition duration-200 shadow-sm">
                  View Details
                </a>
              </div>
            `;
          }).join('');
          listContainer.innerHTML = reportsHtml;
        }
        
          // Ensure renderStoredAnalysis is called after authentication
          document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseAndAuthenticate().then(() => {
              renderStoredAnalysis();
            });
          });
    </script>
    <!-- <script type="module">
      // Example: In aggregateUserDataFromSubscriptions, fetch real quotas
      async function aggregateUserDataFromSubscriptions() {
        // ... simulate or fetch from db.collection('users').doc(uid).get() for paidServices, quota, etc.
      }
    </script> -->
</body>
</html>
